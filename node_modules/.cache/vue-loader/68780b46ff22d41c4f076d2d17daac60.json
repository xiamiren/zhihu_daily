{"remainingRequest":"C:\\Users\\James\\Desktop\\kejian\\vue3知乎日报\\zhihu\\node_modules\\vue-loader-v16\\dist\\index.js??ref--0-1!C:\\Users\\James\\Desktop\\kejian\\vue3知乎日报\\zhihu\\src\\pages\\Login.vue?vue&type=style&index=0&id=15717af5&lang=less&scoped=true","dependencies":[{"path":"C:\\Users\\James\\Desktop\\kejian\\vue3知乎日报\\zhihu\\src\\pages\\Login.vue","mtime":1658979157304},{"path":"C:\\Users\\James\\Desktop\\kejian\\vue3知乎日报\\zhihu\\node_modules\\css-loader\\dist\\cjs.js","mtime":1658554873086},{"path":"C:\\Users\\James\\Desktop\\kejian\\vue3知乎日报\\zhihu\\node_modules\\vue-loader-v16\\dist\\stylePostLoader.js","mtime":1658554967941},{"path":"C:\\Users\\James\\Desktop\\kejian\\vue3知乎日报\\zhihu\\node_modules\\postcss-loader\\src\\index.js","mtime":1658554875926},{"path":"C:\\Users\\James\\Desktop\\kejian\\vue3知乎日报\\zhihu\\node_modules\\less-loader\\dist\\cjs.js","mtime":1658554862180},{"path":"C:\\Users\\James\\Desktop\\kejian\\vue3知乎日报\\zhihu\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1658554939499},{"path":"C:\\Users\\James\\Desktop\\kejian\\vue3知乎日报\\zhihu\\node_modules\\vue-loader-v16\\dist\\index.js","mtime":1658554910597}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:DQoudmFuLWZvcm0gew0KICBtYXJnaW4tdG9wOiAzMHB4Ow0KDQogIC5mb3JtLWJ0biB7DQogICAgd2lkdGg6IDc4cHg7DQogIH0NCn0NCg=="},{"version":3,"sources":["C:\\Users\\James\\Desktop\\kejian\\vue3知乎日报\\zhihu\\src\\pages\\Login.vue"],"names":[],"mappings":";AA2IA,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE;EACR,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;;EAEhB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE;IACR,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;EACb;AACF","file":"C:/Users/James/Desktop/kejian/vue3知乎日报/zhihu/src/pages/Login.vue","sourceRoot":"","sourcesContent":["<template>\r\n  <Nav />\r\n  <van-form ref=\"formBox\" @submit=\"submit\">\r\n    <van-cell-group inset>\r\n      <!-- 手机号 -->\r\n      <van-field\r\n        v-model=\"phone\"\r\n        center\r\n        label=\"手机号\"\r\n        label-width=\"50px\"\r\n        name=\"phone\"\r\n        :rules=\"[\r\n          { required: true, message: '手机号为必填项' },\r\n          { pattern: regPhone, message: '手机号格式不对哦~' },\r\n        ]\"\r\n      >\r\n        <template #button>\r\n          <van-button\r\n            size=\"small\"\r\n            :type=\"enable ? 'primary' : ''\"\r\n            @click=\"sendcode\"\r\n            class=\"form-btn\"\r\n            :disabled=\"!enable\"\r\n          >\r\n            {{ enable ? \"发送验证码\" : time }}\r\n          </van-button>\r\n        </template>\r\n      </van-field>\r\n      <!-- 验证码 -->\r\n      <van-field\r\n        v-model=\"code\"\r\n        label=\"验证码\"\r\n        label-width=\"50px\"\r\n        :rules=\"[\r\n          { required: true, message: '验证码为必填项' },\r\n          { pattern: regCode, message: '验证码必须是六位数字哦' },\r\n        ]\"\r\n      />\r\n    </van-cell-group>\r\n\r\n    <!-- 登录/注册按钮 -->\r\n    <div style=\"margin: 20px 40px\">\r\n      <van-button round block type=\"primary\" native-type=\"submit\">\r\n        立即登录/注册\r\n      </van-button>\r\n    </div>\r\n  </van-form>\r\n</template>\r\n\r\n<script>\r\nimport Nav from \"@/components/Nav.vue\";\r\nimport { reactive, toRefs, ref } from \"vue\";\r\nimport api from \"../api/index\";\r\nimport { Toast } from \"vant\";\r\nimport { useStore} from 'vuex';\r\nimport{useRouter, useRoute} from 'vue-router'\r\nexport default {\r\n  components: { Nav },\r\n  name: \"Login\",\r\n  setup() {\r\n    const store = useStore(),\r\n     router = useRouter(),\r\n     route = useRoute();\r\n\r\n    let state = reactive({\r\n      phone: \"\",\r\n      code: \"\",\r\n      enable: true,\r\n      time: \"60s\",\r\n    });\r\n    let formBox = ref(null);\r\n    // 发送验证码\r\n    const sendcode = async () => {\r\n      try {\r\n        // 校验手机号\r\n        await formBox.value.validate(\"phone\");\r\n        // 发送请求\r\n        let { code } = await api.phoneCode(state.phone);\r\n        if (+code !== 0) {\r\n          Toast(\"当前网络繁忙，请稍后再试！\");\r\n          return;\r\n        }\r\n        // 开启倒计时\r\n        state.enable = false;\r\n        state.time = `10s`;\r\n        let n = 10;\r\n        let timer = setInterval(() => {\r\n          n--;\r\n          if (n === 0) {\r\n            clearInterval(timer);\r\n            state.enable = true;\r\n            return;\r\n          }\r\n          state.time = `${n}s`;\r\n        }, 1000);\r\n      } catch (error) {}\r\n    };\r\n    // 表单提交\r\n    const submit = async () => {\r\n      // 登录\r\n      let { code, token } = await api.login(state.phone, state.code);\r\n      // 通过code，验证是否登录成功\r\n      if(+code !== 0) {\r\n        Toast('小主很遗憾，当前登录失败了!');\r\n        formBox.value.resetValidation();\r\n        state.code = '';\r\n        return;\r\n      }\r\n      // 存储token信息\r\n      localStorage.setItem('token', token);\r\n      // 存储是否登录的状态\r\n      store.commit('changeIsLogin', true);\r\n      // 存储获取到的登录的信息\r\n      store.dispatch('changeAsyncInfo')\r\n      // 清除vuex中已有的storelist的信息\r\n      store.commit('changeStoreList', null);\r\n      Toast('小主真棒，当前登录成功了!');\r\n      let from = route.query.from;\r\n      // route中如果有from跳转到from，没有from跳转到个人中心\r\n      if(from) {\r\n        router.replace(`/${from}`);\r\n        return;\r\n      }\r\n      router.replace(`/person`);\r\n    };\r\n\r\n    return {\r\n      ...toRefs(state),\r\n      formBox,\r\n      regPhone: /^1\\d{10}/,\r\n      regCode: /\\d{6}/,\r\n      sendcode,\r\n      submit,\r\n    };\r\n  },\r\n};\r\n</script>\r\n\r\n<style lang=\"less\" scoped>\r\n.van-form {\r\n  margin-top: 30px;\r\n\r\n  .form-btn {\r\n    width: 78px;\r\n  }\r\n}\r\n</style>\r\n"]}]}